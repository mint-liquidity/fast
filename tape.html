<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINT | The Tape</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --mint-navy: #0B0D11;
            --mint-navy-light: #12151A;
            --mint-gray: #3B4046;
            --mint-gray-light: #6B7280;
            --mint-white: #E5E7EB;
            --mint-green: #059669;
            --mint-red: #DC2626;
            --mint-amber: #D97706;
            --mint-blue: #007AFF;
            --surface-base: #0B0D11;
            --surface-card: #12151A;
            --surface-elevated: #1A1E25;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-medium: rgba(255, 255, 255, 0.10);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--surface-base);
            color: var(--mint-white);
            min-height: 100vh;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Navigation */
        .mint-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 24px;
            background: var(--surface-card);
            border-bottom: 1px solid var(--border-subtle);
        }
        .mint-nav-left { display: flex; align-items: center; gap: 32px; }
        .mint-nav-logo { font-size: 15px; font-weight: 600; color: var(--mint-white); letter-spacing: 0.3px; }
        .mint-nav-tabs { display: flex; gap: 8px; }
        .nav-tab {
            padding: 10px 24px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--mint-gray-light);
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }
        .nav-tab:hover { border-color: var(--mint-gray); color: var(--mint-white); }
        .nav-tab.active { color: var(--mint-white); background: var(--surface-elevated); border-color: var(--mint-white); }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: calc(100vh - 57px);
        }

        /* Filter Panel */
        .filter-panel {
            background: var(--surface-card);
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
            padding: 16px;
        }
        .filter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .filter-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--mint-white);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .filter-reset {
            font-size: 10px;
            color: var(--mint-blue);
            cursor: pointer;
            background: none;
            border: none;
        }
        .filter-reset:hover { text-decoration: underline; }

        .filter-section {
            margin-bottom: 20px;
        }
        .filter-section-title {
            font-size: 9px;
            font-weight: 600;
            color: var(--mint-gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        /* Filter Controls */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .filter-chip {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--mint-gray-light);
            background: var(--surface-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-chip:hover { border-color: var(--mint-gray); color: var(--mint-white); }
        .filter-chip.active {
            background: var(--mint-blue);
            border-color: var(--mint-blue);
            color: white;
        }

        .filter-range {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .filter-range-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-range-label {
            font-size: 10px;
            color: var(--mint-gray-light);
            width: 40px;
        }
        .filter-input {
            flex: 1;
            padding: 8px 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--mint-white);
            background: var(--surface-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            outline: none;
        }
        .filter-input:focus { border-color: var(--mint-blue); }
        .filter-input::placeholder { color: var(--mint-gray); }

        .filter-slider {
            width: 100%;
            margin: 8px 0;
            accent-color: var(--mint-blue);
        }
        .filter-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--mint-gray-light);
            font-family: 'JetBrains Mono', monospace;
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
        }
        .filter-toggle-switch {
            width: 36px;
            height: 20px;
            background: var(--mint-gray);
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
        }
        .filter-toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        .filter-toggle.active .filter-toggle-switch {
            background: var(--mint-blue);
        }
        .filter-toggle.active .filter-toggle-switch::after {
            transform: translateX(16px);
        }
        .filter-toggle-label {
            font-size: 11px;
            color: var(--mint-white);
        }

        /* Presets */
        .filter-presets {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }
        .filter-preset {
            padding: 10px 12px;
            font-size: 11px;
            color: var(--mint-gray-light);
            background: var(--surface-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
        }
        .filter-preset:hover { border-color: var(--mint-gray); color: var(--mint-white); }
        .filter-preset-name { font-weight: 600; color: var(--mint-white); display: block; margin-bottom: 2px; }
        .filter-preset-desc { font-size: 10px; }

        /* Results Panel */
        .results-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Results Header */
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--surface-card);
            border-bottom: 1px solid var(--border-subtle);
        }
        .results-count {
            font-size: 12px;
            color: var(--mint-white);
        }
        .results-count span {
            font-family: 'JetBrains Mono', monospace;
            color: var(--mint-blue);
            font-weight: 600;
        }
        .active-filters {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .active-filter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            font-size: 10px;
            color: var(--mint-white);
            background: rgba(0, 122, 255, 0.2);
            border: 1px solid var(--mint-blue);
            border-radius: 4px;
        }
        .active-filter-tag button {
            background: none;
            border: none;
            color: var(--mint-gray-light);
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }
        .active-filter-tag button:hover { color: var(--mint-white); }

        /* Invoice Table */
        .invoice-table-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }
        .invoice-table th {
            position: sticky;
            top: 0;
            padding: 10px 16px;
            text-align: left;
            font-size: 9px;
            font-weight: 600;
            color: var(--mint-gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--surface-card);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 10;
        }
        .invoice-table th.sortable { cursor: pointer; }
        .invoice-table th.sortable:hover { color: var(--mint-white); }
        .invoice-table th .sort-icon { margin-left: 4px; opacity: 0.5; }
        .invoice-table th.sorted .sort-icon { opacity: 1; }

        .invoice-table td {
            padding: 12px 16px;
            font-size: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .invoice-table tr { cursor: pointer; transition: background 0.1s; }
        .invoice-table tr:hover { background: var(--surface-elevated); }
        .invoice-table tr.selected { background: rgba(0, 122, 255, 0.1); }

        .inv-id { font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--mint-white); }
        .inv-obligor {
            display: inline-block;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 2px;
        }
        .inv-obligor.tjx { background: rgba(59, 130, 246, 0.15); color: #60A5FA; }
        .inv-obligor.olli { background: rgba(16, 185, 129, 0.15); color: #34D399; }
        .inv-obligor.rost { background: rgba(245, 158, 11, 0.15); color: #FBBF24; }
        .inv-obligor.burl { background: rgba(139, 92, 246, 0.15); color: #A78BFA; }

        .inv-amount { font-family: 'JetBrains Mono', monospace; text-align: right; }
        .inv-days { font-family: 'JetBrains Mono', monospace; text-align: center; }
        .inv-days.urgent { color: var(--mint-red); }
        .inv-days.soon { color: var(--mint-amber); }
        .inv-days.normal { color: var(--mint-green); }

        .inv-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 2px;
        }
        .inv-status.matched { background: rgba(5, 150, 105, 0.15); color: var(--mint-green); }
        .inv-status.pending { background: rgba(217, 119, 6, 0.15); color: var(--mint-amber); }
        .inv-status.disputed { background: rgba(220, 38, 38, 0.15); color: var(--mint-red); }

        .inv-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
        }
        .inv-score.high { color: var(--mint-green); }
        .inv-score.medium { color: var(--mint-amber); }
        .inv-score.low { color: var(--mint-red); }

        .inv-action {
            padding: 6px 12px;
            font-size: 10px;
            font-weight: 600;
            color: var(--mint-blue);
            background: rgba(0, 122, 255, 0.1);
            border: 1px solid var(--mint-blue);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .inv-action:hover { background: var(--mint-blue); color: white; }

        /* Summary Bar */
        .summary-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--surface-card);
            border-top: 1px solid var(--border-subtle);
        }
        .summary-metrics {
            display: flex;
            gap: 32px;
        }
        .summary-metric {
            text-align: center;
        }
        .summary-metric-label {
            font-size: 9px;
            color: var(--mint-gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-metric-value {
            font-size: 18px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--mint-white);
        }
        .summary-actions {
            display: flex;
            gap: 12px;
        }
        .summary-btn {
            padding: 10px 20px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .summary-btn.primary {
            background: var(--mint-blue);
            color: white;
            border: none;
        }
        .summary-btn.primary:hover { background: #0066DD; }
        .summary-btn.secondary {
            background: transparent;
            color: var(--mint-white);
            border: 1px solid var(--mint-gray);
        }
        .summary-btn.secondary:hover { background: var(--surface-elevated); }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="mint-nav">
        <div class="mint-nav-left">
            <div class="mint-nav-logo">MINT</div>
            <div class="mint-nav-tabs">
                <a href="tape.html" class="nav-tab active">The Tape</a>
                <a href="checkpoint.html" class="nav-tab">Checkpoint</a>
                <a href="agents.html" class="nav-tab">Agents</a>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Filter Panel -->
        <div class="filter-panel">
            <div class="filter-header">
                <span class="filter-title">Filter Invoices</span>
                <button class="filter-reset" onclick="resetFilters()">Reset All</button>
            </div>

            <!-- Obligor Filter -->
            <div class="filter-section">
                <div class="filter-section-title">Obligor</div>
                <div class="filter-chips" id="obligorChips">
                    <div class="filter-chip active" data-value="all" onclick="toggleObligor(this)">All</div>
                    <div class="filter-chip" data-value="tjx" onclick="toggleObligor(this)">TJX</div>
                    <div class="filter-chip" data-value="olli" onclick="toggleObligor(this)">OLLI</div>
                    <div class="filter-chip" data-value="rost" onclick="toggleObligor(this)">ROST</div>
                    <div class="filter-chip" data-value="burl" onclick="toggleObligor(this)">BURL</div>
                </div>
            </div>

            <!-- Amount Range -->
            <div class="filter-section">
                <div class="filter-section-title">Amount Range</div>
                <div class="filter-range">
                    <div class="filter-range-row">
                        <span class="filter-range-label">Min</span>
                        <input type="text" class="filter-input" id="amountMin" placeholder="$0" oninput="applyFilters()">
                    </div>
                    <div class="filter-range-row">
                        <span class="filter-range-label">Max</span>
                        <input type="text" class="filter-input" id="amountMax" placeholder="$500,000" oninput="applyFilters()">
                    </div>
                </div>
            </div>

            <!-- Days to Due -->
            <div class="filter-section">
                <div class="filter-section-title">Days to Due</div>
                <input type="range" class="filter-slider" id="daysSlider" min="0" max="90" value="90" oninput="updateDaysLabel(); applyFilters()">
                <div class="filter-slider-labels">
                    <span>0</span>
                    <span id="daysValue">≤90 days</span>
                    <span>90</span>
                </div>
            </div>

            <!-- ReIM Status -->
            <div class="filter-section">
                <div class="filter-section-title">ReIM Status</div>
                <div class="filter-chips" id="statusChips">
                    <div class="filter-chip active" data-value="all" onclick="toggleStatus(this)">All</div>
                    <div class="filter-chip" data-value="matched" onclick="toggleStatus(this)">Matched</div>
                    <div class="filter-chip" data-value="pending" onclick="toggleStatus(this)">Pending</div>
                    <div class="filter-chip" data-value="disputed" onclick="toggleStatus(this)">Disputed</div>
                </div>
            </div>

            <!-- Risk Score -->
            <div class="filter-section">
                <div class="filter-section-title">Min Risk Score</div>
                <input type="range" class="filter-slider" id="scoreSlider" min="0" max="100" value="0" oninput="updateScoreLabel(); applyFilters()">
                <div class="filter-slider-labels">
                    <span>0%</span>
                    <span id="scoreValue">≥0%</span>
                    <span>100%</span>
                </div>
            </div>

            <!-- Toggles -->
            <div class="filter-section">
                <div class="filter-section-title">Verification</div>
                <div class="filter-toggle active" id="toggleROG" onclick="toggleFilter('toggleROG')">
                    <div class="filter-toggle-switch"></div>
                    <span class="filter-toggle-label">ROG Confirmed</span>
                </div>
                <div class="filter-toggle active" id="togglePO" onclick="toggleFilter('togglePO')">
                    <div class="filter-toggle-switch"></div>
                    <span class="filter-toggle-label">PO Matched</span>
                </div>
                <div class="filter-toggle" id="toggleFunded" onclick="toggleFilter('toggleFunded')">
                    <div class="filter-toggle-switch"></div>
                    <span class="filter-toggle-label">Never Funded</span>
                </div>
            </div>

            <!-- Presets -->
            <div class="filter-presets">
                <div class="filter-section-title">Quick Presets</div>
                <button class="filter-preset" onclick="applyPreset('highValue')">
                    <span class="filter-preset-name">High Value Ready</span>
                    <span class="filter-preset-desc">≥$50K, Matched, Score ≥85%</span>
                </button>
                <button class="filter-preset" onclick="applyPreset('urgent')">
                    <span class="filter-preset-name">Urgent (≤7 Days)</span>
                    <span class="filter-preset-desc">Due soon, all statuses</span>
                </button>
                <button class="filter-preset" onclick="applyPreset('cleanOnly')">
                    <span class="filter-preset-name">Clean Only</span>
                    <span class="filter-preset-desc">Matched, ROG, PO, Score ≥90%</span>
                </button>
                <button class="filter-preset" onclick="applyPreset('review')">
                    <span class="filter-preset-name">Needs Review</span>
                    <span class="filter-preset-desc">Pending or Disputed</span>
                </button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel">
            <!-- Results Header -->
            <div class="results-header">
                <div class="results-count">
                    Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> invoices
                </div>
                <div class="active-filters" id="activeFilters"></div>
            </div>

            <!-- Invoice Table -->
            <div class="invoice-table-container">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortBy('id')">Invoice ID <span class="sort-icon">↕</span></th>
                            <th class="sortable" onclick="sortBy('obligor')">Obligor <span class="sort-icon">↕</span></th>
                            <th class="sortable" onclick="sortBy('supplier')">Supplier <span class="sort-icon">↕</span></th>
                            <th class="sortable" onclick="sortBy('po')">PO Ref <span class="sort-icon">↕</span></th>
                            <th class="sortable" onclick="sortBy('amount')" style="text-align: right;">Amount <span class="sort-icon">↕</span></th>
                            <th class="sortable" onclick="sortBy('days')" style="text-align: center;">Days <span class="sort-icon">↕</span></th>
                            <th>Status</th>
                            <th class="sortable" onclick="sortBy('score')">Score <span class="sort-icon">↕</span></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="invoiceBody"></tbody>
                </table>
            </div>

            <!-- Summary Bar -->
            <div class="summary-bar">
                <div class="summary-metrics">
                    <div class="summary-metric">
                        <div class="summary-metric-label">Total Value</div>
                        <div class="summary-metric-value" id="totalValue">$0</div>
                    </div>
                    <div class="summary-metric">
                        <div class="summary-metric-label">Avg Score</div>
                        <div class="summary-metric-value" id="avgScore">0%</div>
                    </div>
                    <div class="summary-metric">
                        <div class="summary-metric-label">Weighted Avg Days</div>
                        <div class="summary-metric-value" id="avgDays">0</div>
                    </div>
                    <div class="summary-metric">
                        <div class="summary-metric-label">Selected</div>
                        <div class="summary-metric-value" id="selectedCount">0</div>
                    </div>
                </div>
                <div class="summary-actions">
                    <button class="summary-btn secondary" onclick="exportFiltered()">Export CSV</button>
                    <button class="summary-btn primary" onclick="verifySelected()">Verify Selected</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample invoice data
        const invoices = [
            { id: 'INV-2024-847291', obligor: 'tjx', supplier: 'Acme Textiles', po: 'PO-2024-003847', amount: 127450, days: 14, status: 'matched', score: 94, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847292', obligor: 'tjx', supplier: 'Global Fabrics', po: 'PO-2024-003848', amount: 89200, days: 21, status: 'matched', score: 91, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847293', obligor: 'olli', supplier: 'Pacific Trading', po: 'PO-2024-005123', amount: 234500, days: 7, status: 'matched', score: 88, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847294', obligor: 'olli', supplier: 'Delta Imports', po: 'PO-2024-005124', amount: 67800, days: 28, status: 'pending', score: 72, rog: false, poMatch: true, funded: false },
            { id: 'INV-2024-847295', obligor: 'rost', supplier: 'Summit Goods', po: 'PO-2024-008901', amount: 445000, days: 3, status: 'matched', score: 96, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847296', obligor: 'rost', supplier: 'Metro Supply', po: 'PO-2024-008902', amount: 156700, days: 35, status: 'matched', score: 89, rog: true, poMatch: true, funded: true },
            { id: 'INV-2024-847297', obligor: 'burl', supplier: 'Prime Vendors', po: 'PO-2024-002341', amount: 78900, days: 12, status: 'disputed', score: 45, rog: true, poMatch: false, funded: false },
            { id: 'INV-2024-847298', obligor: 'tjx', supplier: 'Eastern Mills', po: 'PO-2024-003849', amount: 312000, days: 5, status: 'matched', score: 92, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847299', obligor: 'olli', supplier: 'Coastal Corp', po: 'PO-2024-005125', amount: 198400, days: 18, status: 'matched', score: 87, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847300', obligor: 'rost', supplier: 'Alpine Goods', po: 'PO-2024-008903', amount: 542100, days: 42, status: 'pending', score: 78, rog: false, poMatch: true, funded: false },
            { id: 'INV-2024-847301', obligor: 'burl', supplier: 'Valley Trade', po: 'PO-2024-002342', amount: 89500, days: 9, status: 'matched', score: 85, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847302', obligor: 'tjx', supplier: 'Harbor Imports', po: 'PO-2024-003850', amount: 267300, days: 22, status: 'matched', score: 93, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847303', obligor: 'olli', supplier: 'Ridge Supply', po: 'PO-2024-005126', amount: 145600, days: 31, status: 'matched', score: 90, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847304', obligor: 'rost', supplier: 'Central Trading', po: 'PO-2024-008904', amount: 378200, days: 6, status: 'matched', score: 95, rog: true, poMatch: true, funded: false },
            { id: 'INV-2024-847305', obligor: 'burl', supplier: 'Western Goods', po: 'PO-2024-002343', amount: 56700, days: 45, status: 'pending', score: 68, rog: false, poMatch: true, funded: false },
        ];

        let filters = {
            obligor: 'all',
            status: 'all',
            amountMin: 0,
            amountMax: Infinity,
            maxDays: 90,
            minScore: 0,
            rogConfirmed: true,
            poMatched: true,
            neverFunded: false
        };

        let selectedInvoices = new Set();
        let sortColumn = 'id';
        let sortDirection = 'asc';

        function toggleObligor(chip) {
            document.querySelectorAll('#obligorChips .filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            filters.obligor = chip.dataset.value;
            applyFilters();
        }

        function toggleStatus(chip) {
            document.querySelectorAll('#statusChips .filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            filters.status = chip.dataset.value;
            applyFilters();
        }

        function toggleFilter(id) {
            const toggle = document.getElementById(id);
            toggle.classList.toggle('active');
            if (id === 'toggleROG') filters.rogConfirmed = toggle.classList.contains('active');
            if (id === 'togglePO') filters.poMatched = toggle.classList.contains('active');
            if (id === 'toggleFunded') filters.neverFunded = toggle.classList.contains('active');
            applyFilters();
        }

        function updateDaysLabel() {
            const val = document.getElementById('daysSlider').value;
            document.getElementById('daysValue').textContent = `≤${val} days`;
            filters.maxDays = parseInt(val);
        }

        function updateScoreLabel() {
            const val = document.getElementById('scoreSlider').value;
            document.getElementById('scoreValue').textContent = `≥${val}%`;
            filters.minScore = parseInt(val);
        }

        function parseAmount(str) {
            if (!str) return null;
            return parseFloat(str.replace(/[$,]/g, '')) || null;
        }

        function applyFilters() {
            filters.amountMin = parseAmount(document.getElementById('amountMin').value) || 0;
            filters.amountMax = parseAmount(document.getElementById('amountMax').value) || Infinity;
            renderTable();
            updateActiveFilters();
        }

        function resetFilters() {
            filters = {
                obligor: 'all',
                status: 'all',
                amountMin: 0,
                amountMax: Infinity,
                maxDays: 90,
                minScore: 0,
                rogConfirmed: true,
                poMatched: true,
                neverFunded: false
            };
            document.querySelectorAll('.filter-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.value === 'all');
            });
            document.getElementById('amountMin').value = '';
            document.getElementById('amountMax').value = '';
            document.getElementById('daysSlider').value = 90;
            document.getElementById('scoreSlider').value = 0;
            document.getElementById('toggleROG').classList.add('active');
            document.getElementById('togglePO').classList.add('active');
            document.getElementById('toggleFunded').classList.remove('active');
            updateDaysLabel();
            updateScoreLabel();
            applyFilters();
        }

        function applyPreset(preset) {
            resetFilters();
            switch(preset) {
                case 'highValue':
                    document.getElementById('amountMin').value = '$50,000';
                    document.getElementById('scoreSlider').value = 85;
                    filters.amountMin = 50000;
                    filters.minScore = 85;
                    toggleStatus(document.querySelector('#statusChips [data-value="matched"]'));
                    break;
                case 'urgent':
                    document.getElementById('daysSlider').value = 7;
                    filters.maxDays = 7;
                    break;
                case 'cleanOnly':
                    document.getElementById('scoreSlider').value = 90;
                    filters.minScore = 90;
                    toggleStatus(document.querySelector('#statusChips [data-value="matched"]'));
                    break;
                case 'review':
                    document.getElementById('toggleROG').classList.remove('active');
                    filters.rogConfirmed = false;
                    break;
            }
            updateDaysLabel();
            updateScoreLabel();
            applyFilters();
        }

        function getFilteredInvoices() {
            return invoices.filter(inv => {
                if (filters.obligor !== 'all' && inv.obligor !== filters.obligor) return false;
                if (filters.status !== 'all' && inv.status !== filters.status) return false;
                if (inv.amount < filters.amountMin) return false;
                if (inv.amount > filters.amountMax) return false;
                if (inv.days > filters.maxDays) return false;
                if (inv.score < filters.minScore) return false;
                if (filters.rogConfirmed && !inv.rog) return false;
                if (filters.poMatched && !inv.poMatch) return false;
                if (filters.neverFunded && inv.funded) return false;
                return true;
            });
        }

        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderTable();
        }

        function renderTable() {
            let filtered = getFilteredInvoices();

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('invoiceBody');
            tbody.innerHTML = filtered.map(inv => `
                <tr class="${selectedInvoices.has(inv.id) ? 'selected' : ''}"
                    onclick="toggleSelect('${inv.id}')"
                    data-invoice='${JSON.stringify(inv)}'>
                    <td class="inv-id">${inv.id}</td>
                    <td><span class="inv-obligor ${inv.obligor}">${inv.obligor.toUpperCase()}</span></td>
                    <td>${inv.supplier}</td>
                    <td class="mono" style="font-size: 11px; color: var(--mint-gray-light);">${inv.po}</td>
                    <td class="inv-amount">$${inv.amount.toLocaleString()}</td>
                    <td class="inv-days ${inv.days <= 7 ? 'urgent' : inv.days <= 14 ? 'soon' : 'normal'}">${inv.days}</td>
                    <td><span class="inv-status ${inv.status}">${inv.status.toUpperCase()}</span></td>
                    <td class="inv-score ${inv.score >= 85 ? 'high' : inv.score >= 70 ? 'medium' : 'low'}">${inv.score}%</td>
                    <td><button class="inv-action" onclick="event.stopPropagation(); verifyInvoice('${inv.id}', '${inv.po}', '${inv.obligor}')">Verify</button></td>
                </tr>
            `).join('');

            // Update counts
            document.getElementById('filteredCount').textContent = filtered.length;
            document.getElementById('totalCount').textContent = invoices.length;

            // Update summary
            const totalValue = filtered.reduce((sum, inv) => sum + inv.amount, 0);
            const avgScore = filtered.length ? (filtered.reduce((sum, inv) => sum + inv.score, 0) / filtered.length).toFixed(0) : 0;
            const avgDays = filtered.length ? (filtered.reduce((sum, inv) => sum + inv.days * inv.amount, 0) / totalValue).toFixed(1) : 0;

            document.getElementById('totalValue').textContent = '$' + (totalValue / 1000000).toFixed(2) + 'M';
            document.getElementById('avgScore').textContent = avgScore + '%';
            document.getElementById('avgDays').textContent = avgDays;
        }

        function toggleSelect(id) {
            if (selectedInvoices.has(id)) {
                selectedInvoices.delete(id);
            } else {
                selectedInvoices.add(id);
            }
            document.getElementById('selectedCount').textContent = selectedInvoices.size;
            renderTable();
        }

        function verifyInvoice(id, po, obligor) {
            const params = new URLSearchParams({ inv: id, po: po, obligor: obligor });
            window.location.href = `checkpoint.html?${params.toString()}`;
        }

        function verifySelected() {
            if (selectedInvoices.size === 0) {
                alert('Select invoices first');
                return;
            }
            const ids = Array.from(selectedInvoices).join(',');
            window.location.href = `checkpoint.html?batch=${ids}`;
        }

        function exportFiltered() {
            const filtered = getFilteredInvoices();
            const csv = [
                ['Invoice ID', 'Obligor', 'Supplier', 'PO Ref', 'Amount', 'Days', 'Status', 'Score'].join(','),
                ...filtered.map(inv => [inv.id, inv.obligor.toUpperCase(), inv.supplier, inv.po, inv.amount, inv.days, inv.status, inv.score + '%'].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mint_tape_export.csv';
            a.click();
        }

        function updateActiveFilters() {
            const tags = [];
            if (filters.obligor !== 'all') tags.push(`Obligor: ${filters.obligor.toUpperCase()}`);
            if (filters.status !== 'all') tags.push(`Status: ${filters.status}`);
            if (filters.amountMin > 0) tags.push(`Min: $${filters.amountMin.toLocaleString()}`);
            if (filters.amountMax < Infinity) tags.push(`Max: $${filters.amountMax.toLocaleString()}`);
            if (filters.maxDays < 90) tags.push(`≤${filters.maxDays} days`);
            if (filters.minScore > 0) tags.push(`Score ≥${filters.minScore}%`);

            document.getElementById('activeFilters').innerHTML = tags.map(t =>
                `<span class="active-filter-tag">${t}</span>`
            ).join('');
        }

        // Init
        renderTable();
    </script>
</body>
</html>
